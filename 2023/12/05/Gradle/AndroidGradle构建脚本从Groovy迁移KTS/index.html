<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>AndroidGradle构建脚本从Groovy迁移KTS | Glan Wang</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">AndroidGradle构建脚本从Groovy迁移KTS</h1><a id="logo" href="/.">Glan Wang</a><p class="description">CoderGC</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">AndroidGradle构建脚本从Groovy迁移KTS</h1><div class="post-meta">Dec 5, 2023<span> | </span><span class="category"><a href="/categories/Gradle/">Gradle</a></span></div><div class="post-content"><p>随着Kotlin语言被Google在Android开发方面的推广，目前较新的Gradle插件也全面拥抱Kotlin，采用Kotlin DSL语言的形式对插件配置进行支持。</p>
<h3 id="Why-KTS"><a href="#Why-KTS" class="headerlink" title="Why KTS ?"></a>Why KTS ?</h3><p>Kotlin 脚本 (KTS) 比 Groovy 更适合用于编写 Gradle 脚本，因为采用 Kotlin 编写的代码可读性更高，并且 Kotlin 提供了更好的编译时检查和 IDE 支持。Android Gradle 插件 4.0 支持在 Gradle build 配置中使用 KTS。</p>
<p><strong>KTS</strong>：是指 Kotlin 脚本，这是 Gradle 在 build 配置文件中使用的一种 <a href="https://kotlinlang.org/docs/command-line.html#run-scripts" target="_blank" rel="noopener">Kotlin 语言形式</a>。Kotlin 脚本是<a href="https://kotlinlang.org/docs/command-line.html#using-the-command-line-to-run-scripts" target="_blank" rel="noopener">可从命令行运行</a>的 Kotlin 代码。</p>
<p><strong>Kotlin DSL</strong>：主要是指 <a href="https://developer.android.com/reference/tools/gradle-api?hl=zh-cn" target="_blank" rel="noopener">Android Gradle 插件 Kotlin DSL</a>，有时也指<a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html#kotlin_dsl" target="_blank" rel="noopener">底层 Gradle Kotlin DSL</a>。</p>
<p>在讨论从 Groovy 迁移时，术语“KTS”和“Kotlin DSL”可以互换使用。换句话说，“将 Android 项目从 Groovy 转换为 KTS”与“将 Android 项目从 Groovy 转换为 Kotlin DSL”实际上是一个意思。</p>
<p>我们的项目近期也将构建从Groovy迁移到KotlinDSL，同时我们升级了Android Plugin 、Gradle版本，以及开启了Gradle的Catalog功能管理版本依赖。下面我将对我们项目迁移的过程以及遇到的问题，简单总结一下，这里主要讲述Kotlin DSL配置与Groovy配置的差异</p>
<p>首先声明我们使用的gradle版本和Android Gradle Plugin(AGP)版本分别为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Gradle Version: 7.2</span><br><span class="line"></span><br><span class="line">AGP Version: 7.1.0</span><br></pre></td></tr></table></figure>
<p>具体的AGP和Gradle的版本对照关系可以参考<a href="https://developer.android.com/studio/releases/gradle-plugin?hl=zh-cn" target="_blank" rel="noopener">Android Develpers</a> 网站说明：</p>
<p><img src="/2023/12/05/Gradle/AndroidGradle构建脚本从Groovy迁移KTS/Users/glanwang/Library/Application%20Support/marktext/images/2023-12-05-10-50-31-image.png" alt></p>
<p>处理完版本问题我们可以真正的开始改造了：</p>
<h3 id="Step-1-脚本文件命名"><a href="#Step-1-脚本文件命名" class="headerlink" title="Step 1 脚本文件命名"></a>Step 1 脚本文件命名</h3><p>将<em>.gradle文件重新命名为</em>.gradle.ts文件，例如项目更目录下的settings.gradle重新命名为settings.gradle.kts。</p>
<h3 id="Step-2-转换语法"><a href="#Step-2-转换语法" class="headerlink" title="Step 2 转换语法"></a>Step 2 转换语法</h3><h4 id="2-1-为方法调用添加圆括号"><a href="#2-1-为方法调用添加圆括号" class="headerlink" title="2.1 为方法调用添加圆括号"></a>2.1 为方法调用添加圆括号</h4><p>Kotlin中方法调用不能省略圆括号，因此需要将原Groovy中省略的圆括号全部添加回来。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Groovy</span><br><span class="line">buildConfigField &quot;String&quot;, &quot;BRACH_NAME&quot;, &quot;\&quot;$&#123;branchName()&#125;\&quot;&quot;</span><br><span class="line">implementation &apos;com.google.android.material:material:1.4.0&apos;</span><br><span class="line"></span><br><span class="line"># Kotlin</span><br><span class="line">buildConfigField(&quot;String&quot;, &quot;BRACH_NAME&quot;, &quot;\&quot;$&#123;branchName()&#125;\&quot;&quot;)</span><br><span class="line">implementation(&quot;com.google.android.material:material:1.4.0&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-为属性调用添加"><a href="#2-2-为属性调用添加" class="headerlink" title="2.2  为属性调用添加 ="></a>2.2  为属性调用添加 =</h4><p>Kotlin中所有的属性调用均需要添加赋值等号，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Groovy</span><br><span class="line">minSdk 29</span><br><span class="line">targetSdk 30</span><br><span class="line"></span><br><span class="line"># Kotlin</span><br><span class="line">minSdk = 29</span><br><span class="line">targetSdk = 30</span><br></pre></td></tr></table></figure>
<h4 id="2-3-字符串转换"><a href="#2-3-字符串转换" class="headerlink" title="2.3 字符串转换"></a>2.3 字符串转换</h4><p>Groovy中优先推荐是用单引号设置字符串，Kotlin中则需要使用双引号，因此需要将所有的字符串从单引号改为双引号</p>
<h4 id="2-4-语法-关键字修改"><a href="#2-4-语法-关键字修改" class="headerlink" title="2.4 语法/关键字修改"></a>2.4 语法/关键字修改</h4><p>将Groovy语法转换为Kotlin语法，例如：变量声明：Groovy中使用def， Kotlin中使用var或者val</p>
<h3 id="Step-3各个文件具体分析"><a href="#Step-3各个文件具体分析" class="headerlink" title="Step 3各个文件具体分析"></a>Step 3各个文件具体分析</h3><h4 id="3-1-settings-gradle-kts与settings-gradle-kts"><a href="#3-1-settings-gradle-kts与settings-gradle-kts" class="headerlink" title="3.1 settings.gradle.kts与settings.gradle.kts"></a>3.1 settings.gradle.kts与settings.gradle.kts</h4><p>在settings.gradle.kts中新添加了pluginManagement和dependencyResolutionManagement配置。</p>
<ul>
<li><p>pluginManagement用来管理插件(包括插件仓储配置，插件寻找策略); - </p>
</li>
<li><p>dependencyResolutionManagement用来管理依赖下载的配置。</p>
</li>
<li><p>有了这两个配置之后，原则上build.gradle.kts中可以不用指定buildscript</p>
</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pluginManagement &#123;</span><br><span class="line">    includeBuild(<span class="string">"build-logic"</span>)  <span class="comment">// 指定编译逻辑Library</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用的plugin来源仓库</span></span><br><span class="line">    repositories &#123;   </span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        gradlePluginPortal()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 指定加载策略， 解决部分插件没有 gradle id的问题</span></span><br><span class="line">    resolutionStrategy &#123;</span><br><span class="line">        eachPlugin &#123;</span><br><span class="line">            <span class="keyword">if</span> (requested.id.id == <span class="string">"io.objectbox.objectbox-gradle-plugin"</span>) &#123;</span><br><span class="line">                useModule(<span class="string">"io.objectbox:objectbox-gradle-plugin:<span class="subst">$&#123;requested.version&#125;</span>"</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requested.id.id == <span class="string">"com.google.gms.google.services"</span>) &#123;</span><br><span class="line">                useModule(<span class="string">"com.google.gms:google-services:<span class="subst">$&#123;requested.version&#125;</span>"</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requested.id.id == <span class="string">"com.google.firebase.firebase-crashlytics-gradle"</span>) &#123;</span><br><span class="line">                useModule(<span class="string">"com.google.firebase:firebase-crashlytics-gradle:<span class="subst">$&#123;requested.version&#125;</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 依赖资源的来源仓库</span></span><br><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        flatDir &#123;</span><br><span class="line">            dirs(</span><br><span class="line">                <span class="string">"app/libs"</span>,</span><br><span class="line">                )</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-rootProject-build-gradle-kts-文件"><a href="#3-2-rootProject-build-gradle-kts-文件" class="headerlink" title="3.2  ${rootProject}/build.gradle.kts 文件"></a>3.2  ${rootProject}/build.gradle.kts 文件</h4><ul>
<li><p>${rootProject}/build.gradle.kts中，在plugins{}中使用id或者alias指定classpath, 此处的apply faslse 代表的是只讲次插件放置到编译过程的classpath中</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    <span class="comment">//id需要去gradle插件仓库寻找：https://plugins.gradle.org</span></span><br><span class="line">    alias(libs.plugins.android.application) apply <span class="literal">false</span></span><br><span class="line">    alias(libs.plugins.kotlin.android) apply <span class="literal">false</span></span><br><span class="line">    alias(libs.plugins.kotlin.jvm) apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">"io.objectbox.objectbox-gradle-plugin"</span>) version <span class="string">"2.9.1"</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">"com.google.protobuf"</span>) version <span class="string">"0.8.12"</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">"com.google.gms.google.services"</span>) version <span class="string">"4.3.10"</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">"com.google.firebase.firebase-crashlytics-gradle"</span>) version <span class="string">"2.4.1"</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  <code>注意</code>：有些老的plugin找不到对应的id，应该怎么处理呢？其实有两种方法： </p>
<ul>
<li><p>方法一：直接想之前一样在${rootProject}/build.gradle.kts使用buildscript代码块，声明classpath即可：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123; </span><br><span class="line">        classpath <span class="string">"com.google.protobuf:protobuf-gradle-plugin:<span class="variable">$protobuf_gradle_plugin_version</span>"</span></span><br><span class="line">        classpath <span class="string">"com.google.gms:google-services:<span class="subst">$&#123;googleServiceVersion&#125;</span>"</span></span><br><span class="line">        classpath <span class="string">"com.google.firebase:firebase-crashlytics-gradle:<span class="subst">$&#123;crashlyticGradleVersion&#125;</span>"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>方法二： 给插件自定义一个id名称，然后在pluginManagement中处理寻找策略：</p>
<ol>
<li>${rootProject}/build.gradle.kts文件</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    <span class="comment">//使用自定义的id声明</span></span><br><span class="line">    id(<span class="string">"io.objectbox.objectbox-gradle-plugin"</span>) version <span class="string">"2.9.1"</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">"com.google.protobuf"</span>) version <span class="string">"0.8.12"</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">"com.google.gms.google.services"</span>) version <span class="string">"4.3.10"</span> apply <span class="literal">false</span></span><br><span class="line">    id(<span class="string">"com.google.firebase.firebase-crashlytics-gradle"</span>) version <span class="string">"2.4.1"</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  . ${rootProject}/settings.gradle.kts中指定id寻找策略</p>
<pre><code><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pluginManagement &#123;</span><br><span class="line">    ...</span><br><span class="line">    resolutionStrategy &#123;</span><br><span class="line">        <span class="comment">// 自定义插件id的寻找策略</span></span><br><span class="line">        <span class="comment">// 解决部分插件没有 gradle id的问题</span></span><br><span class="line">        eachPlugin &#123;</span><br><span class="line">            <span class="keyword">if</span> (requested.id.id == <span class="string">"io.objectbox.objectbox-gradle-plugin"</span>) &#123;</span><br><span class="line">                useModule(<span class="string">"io.objectbox:objectbox-gradle-plugin:<span class="subst">$&#123;requested.version&#125;</span>"</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requested.id.id == <span class="string">"com.google.gms.google.services"</span>) &#123;</span><br><span class="line">                useModule(<span class="string">"com.google.gms:google-services:<span class="subst">$&#123;requested.version&#125;</span>"</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requested.id.id == <span class="string">"com.google.firebase.firebase-crashlytics-gradle"</span>) &#123;</span><br><span class="line">                useModule(<span class="string">"com.google.firebase:firebase-crashlytics-gradle:<span class="subst">$&#123;requested.version&#125;</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>关于gradle是如何通过id寻找插件的？</p>
<p>关于这个话题可以单独展开讲，此处简单说一下，gradle通过id查找plugin的规则可以简单理解为通过将id绑定到一个pom文件，然后pom文件里指定plugin的module资源：</p>
<p>根据id从仓库找寻pom依赖文件规则：<a href="https://plugins.gradle.org/m2/{id拼接的path}/{id}.gradle.plugin/{version}/{id}.gradle.plugin-{version}.pom" target="_blank" rel="noopener">https://plugins.gradle.org/m2/{id拼接的path}/{id}.gradle.plugin/{version}/{id}.gradle.plugin-{version}.pom</a></p>
<p>例如寻找com.google.protobuf插件：<a href="https://plugins.gradle.org/m2/com/google/protobuf/com.google.protobuf.gradle.plugin/0.7.3/com.google.protobuf.gradle.plugin-0.7.3.pom" target="_blank" rel="noopener">https://plugins.gradle.org/m2/com/google/protobuf/com.google.protobuf.gradle.plugin/0.7.3/com.google.protobuf.gradle.plugin-0.7.3.pom</a></p>
<p>请求到的pom内容为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>com.google.protobuf.gradle.plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>gradle.plugin.com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-gradle-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-3-app-build-gradle-kts文件"><a href="#3-3-app-build-gradle-kts文件" class="headerlink" title="3.3 app/build.gradle.kts文件"></a>3.3 app/build.gradle.kts文件</h4><ul>
<li><p>注意点一：本地jar引入</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">implementation(fileTree(<span class="string">"libs"</span>) &#123;</span><br><span class="line">        include(<span class="string">"*.jar"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">或</span><br><span class="line">api(fileTree(<span class="string">"libs"</span>) &#123;</span><br><span class="line">        include(<span class="string">"*.jar"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>注意点二： 本地aar引入</p>
<p>引入本地aar文件特别需要注意，必须使用指定方式引入</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">implementation(linkedMapOf(<span class="string">"name"</span> to <span class="string">"mocap4face-0.4.0"</span>, <span class="string">"ext"</span> to <span class="string">"aar"</span>))</span><br><span class="line">或</span><br><span class="line">api(linkedMapOf(<span class="string">"name"</span> to <span class="string">"mocap4face-0.4.0"</span>, <span class="string">"ext"</span> to <span class="string">"aar"</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>  <code>注意</code>：本地aar不能使用以下方式引入, 否则会出现debug可以编译，release包编译报错。具体报错为：</p>
<blockquote>
<p>What went wrong:<br>Execution failed for task ‘:news_memorycanary_release:bundleReleaseLocalLintAar’.</p>
</blockquote>
<blockquote>
<p>Error while evaluating property ‘hasLocalAarDeps’ of task ‘:news_memorycanary_release:bundleReleaseLocalLintAar’<br>Direct local .aar file dependencies are not supported when building an AAR. The resulting AAR would be broken because the classes and Android resources from any local .aar file dependencies would not be packaged in the resulting AAR. Previous versions of the Android Gradle Plugin produce broken AARs in this case too (despite not throwing this error). The following direct local .aar file dependencies of the :news_memorycanary_release project caused this error: /Users/themachine/.jenkins/workspace/android-news-client-feature-2023-sprint-adaptation_t_u_new/news_memorycanary_release/libs/memorycanary_core_1.1.1.aar</p>
</blockquote>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//错误的aar引入方式一</span><br><span class="line">implementation(fileTree(&quot;libs&quot;) &#123;</span><br><span class="line">        include(&quot;*.aar&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">//错误的aar引入方式二</span><br><span class="line">implementation(file(&quot;libs/demo.aar&quot;))</span><br></pre></td></tr></table></figure>
<h4 id="3-4-ext扩展使用"><a href="#3-4-ext扩展使用" class="headerlink" title="3.4 ext扩展使用"></a>3.4 ext扩展使用</h4><p>使用ext的get和set方法，注意使用时需要指定声明ext的project，例如</p>
<ul>
<li><p>${rootProject}/build.gradle.kts中声明    </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">    <span class="keyword">set</span>(<span class="string">"androidCompileSdkVersion"</span>, <span class="number">31</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用androidCompileSdkVersion时，需要指定rootProject</p>
<p>app/build.gradle.kts中使用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">   println(rootProject.ext.<span class="keyword">get</span>(<span class="string">"androidCompileSdkVersion"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>到此为止，基本上从groovy迁移到kts，所遇到的主要问题就说完了。其他相关的问题，例如catalog的使用，includeBuild引入编译逻辑等，后续单独文章详细记录。</p>
</div><div class="tags"><a href="/tags/KTS-kotlin-DSL-gradle-catalog/">KTS,kotlin DSL,gradle,catalog</a></div><div class="post-nav"><a class="next" href="/2023/11/30/Kotlin/用Kotlin痛快的写脚本/">用Kotlin痛快的写脚本</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://glanwang.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/transform-API-gradle/" style="font-size: 15px;">transform API, gradle</a> <a href="/tags/KTS-kotlin-DSL-gradle-catalog/" style="font-size: 15px;">KTS,kotlin DSL,gradle,catalog</a> <a href="/tags/gradle-守护进程，org-gradle-daemon/" style="font-size: 15px;">gradle 守护进程，org.gradle.daemon</a> <a href="/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/tags/IDEA导出可执行jar/" style="font-size: 15px;">IDEA导出可执行jar</a> <a href="/tags/堆，栈/" style="font-size: 15px;">堆，栈</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/transient/" style="font-size: 15px;">transient</a> <a href="/tags/aop-aspectJ/" style="font-size: 15px;">aop, aspectJ</a> <a href="/tags/AOP/" style="font-size: 15px;">AOP</a> <a href="/tags/Kotlin-Kotlin-Script/" style="font-size: 15px;">Kotlin, Kotlin Script</a> <a href="/tags/memory-monitors-android-studio/" style="font-size: 15px;">memory monitors, android studio</a> <a href="/tags/嵌套滚动-NestedScrolling/" style="font-size: 15px;">嵌套滚动, NestedScrolling</a> <a href="/tags/greenDao-数据库/" style="font-size: 15px;">greenDao, 数据库</a> <a href="/tags/systrace/" style="font-size: 15px;">systrace</a> <a href="/tags/design-appBarLayout/" style="font-size: 15px;">design, appBarLayout</a> <a href="/tags/AspectJ-android/" style="font-size: 15px;">AspectJ, android</a> <a href="/tags/quic-cronet-httpDns/" style="font-size: 15px;">quic, cronet, httpDns</a> <a href="/tags/quic-cronet-http3/" style="font-size: 15px;">quic, cronet, http3,</a> <a href="/tags/glide-图片无法加载-获取缓存图片/" style="font-size: 15px;">glide, 图片无法加载, 获取缓存图片</a> <a href="/tags/glide源码解读/" style="font-size: 15px;">glide源码解读</a> <a href="/tags/gradle教程/" style="font-size: 15px;">gradle教程</a> <a href="/tags/gradle，屏蔽，task/" style="font-size: 15px;">gradle，屏蔽，task</a> <a href="/tags/okhttp-header/" style="font-size: 15px;">okhttp, header</a> <a href="/tags/proguard/" style="font-size: 15px;">proguard</a> <a href="/tags/sqltie-GreenDao/" style="font-size: 15px;">sqltie, GreenDao</a> <a href="/tags/Tinker-patch/" style="font-size: 15px;">Tinker, patch</a> <a href="/tags/apktools/" style="font-size: 15px;">apktools</a> <a href="/tags/buildSrc调试/" style="font-size: 15px;">buildSrc调试</a> <a href="/tags/https-httpDNS/" style="font-size: 15px;">https, httpDNS</a> <a href="/tags/事件传递/" style="font-size: 15px;">事件传递</a> <a href="/tags/嵌套滚动-viewpager/" style="font-size: 15px;">嵌套滚动, viewpager</a> <a href="/tags/隐私-Mac-imei/" style="font-size: 15px;">隐私, Mac, imei</a> <a href="/tags/Too-many-classes-in-main-dex-list，-main-dex-capacity-exceeded/" style="font-size: 15px;">Too many classes in --main-dex-list， main dex capacity exceeded</a> <a href="/tags/widget-android-8-0/" style="font-size: 15px;">widget, android 8.0</a> <a href="/tags/热更新-热补丁/" style="font-size: 15px;">热更新, 热补丁</a> <a href="/tags/瘦身/" style="font-size: 15px;">瘦身</a> <a href="/tags/请求追踪/" style="font-size: 15px;">请求追踪</a> <a href="/tags/Android8-0适配/" style="font-size: 15px;">Android8.0适配</a> <a href="/tags/shell字符串/" style="font-size: 15px;">shell字符串</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/正则表达式，shell/" style="font-size: 15px;">正则表达式，shell</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/git-clean/" style="font-size: 15px;">git clean</a> <a href="/tags/git迁移/" style="font-size: 15px;">git迁移</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/12/05/Gradle/AndroidGradle构建脚本从Groovy迁移KTS/">AndroidGradle构建脚本从Groovy迁移KTS</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/11/30/Kotlin/用Kotlin痛快的写脚本/">用Kotlin痛快的写脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/24/Android/工信部隐私问题快速排查整改方案/">工信部隐私问题快速排查整改方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/24/Android/Cronet网络协议选择之HTTP2与QUIC的竞速/">Cronet网络协议选择之HTTP2与QUIC的竞速</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/22/Android/Cronet实现HttpDns/">Cronet实现HttpDns</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/29/Android/Android获取应用磁盘空间占用/">Android获取应用磁盘空间占用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/Android/gradle之buildSrc代码调试/">gradle之buildSrc代码调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/19/Android/Android性能分析之systrace使用/">Android性能分析之systrace使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/03/Android/Tinker接入实践/">Tinker接入实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/21/Android/AOP技术在客户端的应用与实践/">AOP技术在客户端的应用与实践</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">Glan Wang.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>