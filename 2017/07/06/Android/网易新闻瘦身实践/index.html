<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>网易新闻瘦身实践 | Glan Wang</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">网易新闻瘦身实践</h1><a id="logo" href="/.">Glan Wang</a><p class="description">CoderGC</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">网易新闻瘦身实践</h1><div class="post-meta">Jul 6, 2017<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><p>随着业务的不断增长，网易新闻客户端已经承载了过多的功能，不仅仅是一个新闻资讯的app，而是成了公司各个业务线的载体。因此，体积增长的问题就暴露了出来。体积最大时达到了30M，这对一个android应用级别的app来说算是非常大的了。于是不得不把瘦身的工作提到日程上。</p>
<h3 id="分析apk，查看个模块的占比"><a href="#分析apk，查看个模块的占比" class="headerlink" title="分析apk，查看个模块的占比"></a>分析apk，查看个模块的占比</h3><p>这一块目前来说还是非常方便的，直接使用android studio提供的apk分析工具，将自己的apk拉入进去，查看一下包体积的状况即可。<br><img src="/2017/07/06/Android/网易新闻瘦身实践/apkanalyze.jpg" alt><br>如上图所示，可以看到主要的体积占用是再lib下的so库， 资源文件和dex这三个部分。于是我们根据分析采取了以下措施。</p>
<h3 id="实施瘦身"><a href="#实施瘦身" class="headerlink" title="实施瘦身"></a>实施瘦身</h3><h4 id="资源图片的压缩"><a href="#资源图片的压缩" class="headerlink" title="资源图片的压缩"></a>资源图片的压缩</h4><p>对于资源图片，之前一直是收工进行压缩图片。我们对比了目前比较好的图片压缩工具。</p>
<ol>
<li><a href="https://tinypng.com/" target="_blank" rel="noopener">https://tinypng.com</a>  在线的压缩工具，免费版对图片压缩有大小和size限制。但是实践过程中我们发现这个工具对某些图片压缩不成功时竟然出现了比原始图片大的状况。</li>
<li>mac下的压缩工具ImageOptim， 此工具的压缩效果也是不错的，只不过这是一款软件，我们只能每次进行手工操作，集成度不高。那么有没有一款工具能做到效果好，同时可集成度高，不用我们每次进行手工操作的。</li>
<li>pngquant <a href="https://pngquant.org" target="_blank" rel="noopener">https://pngquant.org</a> 开源的图片压缩工具<br>显而易见，我们最终选择了开源的pngquant工具，原因主要有两方面，一、开源，没有限制；二、便于集成。正是这两个方面的原因，我们团队中的小伙伴开发了一个gradle插件，可以对图片进行统一的压缩处理，并且可以使用此插件，依赖lint分析对代码中没有引用的资源文件进行移除。<h4 id="本地图片Webp化"><a href="#本地图片Webp化" class="headerlink" title="本地图片Webp化"></a>本地图片Webp化</h4>对于压缩过的图片，其实效果已经很好了，但是我们考虑还有没有再进行压缩的方案。于是，我们考虑了webp格式的图。对于webp格式的图片，虽然是google的技术，但是在android上使用还是有很大坑的。第一，系统版本的支持，4.0以上才支持webp格式； 第二， 不同版本的支持格式不一样， 4.1以上的系统才支持含透明的的webp图片。<br>由于上边这些坑，我们不得不采取一些折中的方案。一般有两种选型，一、客户端增加开源库以便在低版本系统上支持webp图片；二、客户端只对不含透明度的图片进行webp化，避免4.1一下的手机无法解析的情况。<br>综上所述，我们选择了第二种方案，只将不含透明度的图片进行webp化。<h4 id="Proguard规范化"><a href="#Proguard规范化" class="headerlink" title="Proguard规范化"></a>Proguard规范化</h4>对应Proguard，之前客户端一致没有太注重这方面，导致proguard非常冗余。例如: 很多第三方库都是全部keep的，这就导致了很多无用的类也打包进入了dex文件导致体积的增加。<br>因此，针对这种情况我们采用了case by case的排查。将proguard规范更加细致化。 比如，之前引入的google广告sdk，体积相当庞大，压缩前大约有1M，而proguard中我们直接全部keep的。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.google.** &#123;*;&#125; </span><br><span class="line">-keep class com.tencent.** &#123;*;&#125;</span><br><span class="line">-keep class com.sina.** &#123;*;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这种状况我们做了一下处理，分析对应的sdk包，只keep主sdk中没有混淆的类，sdk中已经做过混淆的类，我们不进行keep。这样就保证了我们调用的api是没有问题的，同时也去除了一些我们没有引用到的类。<br><code>注意: proguard的处理是非常有风险的，需要进行全面的测试</code></p>
<h4 id="so库的处理"><a href="#so库的处理" class="headerlink" title="so库的处理"></a>so库的处理</h4><p>对so库的处理，我们做了两方面的工作。</p>
<h5 id="I-移除除armeabi以外的所有so库"><a href="#I-移除除armeabi以外的所有so库" class="headerlink" title="I 移除除armeabi以外的所有so库"></a>I 移除除armeabi以外的所有so库</h5><p>原因大家应该也都清楚。目前arm处理器的占比已经非常非常高。而且，调研一下你会发现微信，qq等装机量很大的apk都已经移除了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled true</span><br><span class="line">        proguardFiles &apos;proguard.cfg&apos;</span><br><span class="line">        signingConfig signingConfigs.release</span><br><span class="line">        ndk &#123;</span><br><span class="line">            abiFilters &quot;armeabi&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    debug &#123;</span><br><span class="line">        minifyEnabled false</span><br><span class="line">        signingConfig signingConfigs.release</span><br><span class="line">        ndk &#123;</span><br><span class="line">            abiFilters &quot;armeabi&quot;, &quot;x86&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>release状态下我们只保留了armeabi的so，但是debug状态下我们保留了armeabi和x86的so，原因是我们平时开发使用模拟器比较多，保留x86更便于我们平时开发</p>
<h5 id="II-找出armeabi中体积很大的so，实行动态下发机制。"><a href="#II-找出armeabi中体积很大的so，实行动态下发机制。" class="headerlink" title="II 找出armeabi中体积很大的so，实行动态下发机制。"></a>II 找出armeabi中体积很大的so，实行动态下发机制。</h5><p>使用System.load(filePath)方法代替System.loadLibrary(libName)进行动态下发so。<br>当然这个要根据实际情况进行分析，首先要分析so是我们代码中自己进行load的还是sdk中进行load的。一般而言，自己进行load的so非常好处理，我们只需要动态下发，下发完成之后在进行load即可。而对于sdk内部load的so，就会稍微麻烦一点，我们不得不hook sdk内部load so的方法，修改其load的时机和路径。<br>幸运的是，我们遇到的体积最大的so，压缩前5M，是我们的一个播放器使用到的so，于是我们修改了播放器的load so的时机，下载完成之后进行load。 下载完成之前，如果有用户点击视屏，我们直接使用系统自带的MediaPlayer进行播放。</p>
<p><code>注意: System.load(filePath) 此方法的filePath有些手机是不支持sdcard下的文件的，因此动态下发so时，需要将so放到/data/data/{apkId}包下</code></p>
<h4 id="夜间模式"><a href="#夜间模式" class="headerlink" title="夜间模式"></a>夜间模式</h4><p>夜间模式，新闻客户端这边一直使用的比较原始的方式，两套资源的方式。<br>于是我们希望你能做成动态下发夜间资源的形式。这项工作基本已经完成，但是由于种种原因目前还没有正式上线。</p>
<h4 id="支持语言的精简"><a href="#支持语言的精简" class="headerlink" title="支持语言的精简"></a>支持语言的精简</h4><p>引用的很读标准库会支持很多国际语言(如v7等support包会含有很多语言)，其实对于我们来说大多数是没有用的。其实只保留中文和英文基本上已经足够了。</p>
<h3 id="Need-TODO"><a href="#Need-TODO" class="headerlink" title="Need TODO"></a>Need TODO</h3><h4 id="dex瘦身"><a href="#dex瘦身" class="headerlink" title="dex瘦身"></a>dex瘦身</h4><p>由于我们的热更新方案使用的是aop的方式，对字节码进行了修改，导致class文件均会增大，大约增大了1~1.5M，因此我们希望能找到更加合适的方案对字节进行修改，减小最后生成的dex体积。</p>
<h4 id="support的拆分"><a href="#support的拆分" class="headerlink" title="support的拆分"></a>support的拆分</h4><p>google提供的最新的v4包已经对版本进行了拆分，因此我们希望以后只引入需要的support包，以便减小最终dex体积。</p>
<hr>
<p>基于微博网友47Log 的补充:</p>
<h4 id="资源混淆"><a href="#资源混淆" class="headerlink" title="资源混淆"></a>资源混淆</h4><p>其实资源混淆我们很早之前就已经做了，所以上边没有写。我们也是使用它的 AndRes，这个效果还是很明显的，网易新闻大小在24M 左右的时候，走完 AndRes 资源混淆，差不多能减掉1.5~2M。</p>
<h4 id="使用-Vector-进行替换资源"><a href="#使用-Vector-进行替换资源" class="headerlink" title="使用 Vector 进行替换资源"></a>使用 Vector 进行替换资源</h4><p>这个也是可行的，因为 Vector 意味着体积会更小。如果时间允许的话，这个也是缩小体积的一个方面。不过从成本和效果上看不一定会是特别有效的方案。</p>
</div><div class="tags"><a href="/tags/瘦身/">瘦身</a></div><div class="post-nav"><a class="pre" href="/2017/07/14/Android/网易新闻热补丁技术实践/">网易新闻热补丁技术实践</a><a class="next" href="/2017/07/04/Android/AppBarLayout的五中ScrollFlags/">AppBarLayout的五中ScrollFlags</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://glanwang.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Gradle/">Gradle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/IDEA导出可执行jar/" style="font-size: 15px;">IDEA导出可执行jar</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/transform-API-gradle/" style="font-size: 15px;">transform API, gradle</a> <a href="/tags/transient/" style="font-size: 15px;">transient</a> <a href="/tags/gradle-守护进程，org-gradle-daemon/" style="font-size: 15px;">gradle 守护进程，org.gradle.daemon</a> <a href="/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/tags/Kotlin-Kotlin-Script/" style="font-size: 15px;">Kotlin, Kotlin Script</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/git-clean/" style="font-size: 15px;">git clean</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/git迁移/" style="font-size: 15px;">git迁移</a> <a href="/tags/堆，栈/" style="font-size: 15px;">堆，栈</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/shell字符串/" style="font-size: 15px;">shell字符串</a> <a href="/tags/正则表达式，shell/" style="font-size: 15px;">正则表达式，shell</a> <a href="/tags/aop-aspectJ/" style="font-size: 15px;">aop, aspectJ</a> <a href="/tags/AOP/" style="font-size: 15px;">AOP</a> <a href="/tags/memory-monitors-android-studio/" style="font-size: 15px;">memory monitors, android studio</a> <a href="/tags/嵌套滚动-NestedScrolling/" style="font-size: 15px;">嵌套滚动, NestedScrolling</a> <a href="/tags/systrace/" style="font-size: 15px;">systrace</a> <a href="/tags/greenDao-数据库/" style="font-size: 15px;">greenDao, 数据库</a> <a href="/tags/design-appBarLayout/" style="font-size: 15px;">design, appBarLayout</a> <a href="/tags/AspectJ-android/" style="font-size: 15px;">AspectJ, android</a> <a href="/tags/quic-cronet-httpDns/" style="font-size: 15px;">quic, cronet, httpDns</a> <a href="/tags/quic-cronet-http3/" style="font-size: 15px;">quic, cronet, http3,</a> <a href="/tags/glide-图片无法加载-获取缓存图片/" style="font-size: 15px;">glide, 图片无法加载, 获取缓存图片</a> <a href="/tags/glide源码解读/" style="font-size: 15px;">glide源码解读</a> <a href="/tags/gradle教程/" style="font-size: 15px;">gradle教程</a> <a href="/tags/gradle，屏蔽，task/" style="font-size: 15px;">gradle，屏蔽，task</a> <a href="/tags/okhttp-header/" style="font-size: 15px;">okhttp, header</a> <a href="/tags/proguard/" style="font-size: 15px;">proguard</a> <a href="/tags/sqltie-GreenDao/" style="font-size: 15px;">sqltie, GreenDao</a> <a href="/tags/apktools/" style="font-size: 15px;">apktools</a> <a href="/tags/buildSrc调试/" style="font-size: 15px;">buildSrc调试</a> <a href="/tags/https-httpDNS/" style="font-size: 15px;">https, httpDNS</a> <a href="/tags/Tinker-patch/" style="font-size: 15px;">Tinker, patch</a> <a href="/tags/事件传递/" style="font-size: 15px;">事件传递</a> <a href="/tags/嵌套滚动-viewpager/" style="font-size: 15px;">嵌套滚动, viewpager</a> <a href="/tags/隐私-Mac-imei/" style="font-size: 15px;">隐私, Mac, imei</a> <a href="/tags/Too-many-classes-in-main-dex-list，-main-dex-capacity-exceeded/" style="font-size: 15px;">Too many classes in --main-dex-list， main dex capacity exceeded</a> <a href="/tags/widget-android-8-0/" style="font-size: 15px;">widget, android 8.0</a> <a href="/tags/请求追踪/" style="font-size: 15px;">请求追踪</a> <a href="/tags/热更新-热补丁/" style="font-size: 15px;">热更新, 热补丁</a> <a href="/tags/瘦身/" style="font-size: 15px;">瘦身</a> <a href="/tags/Android8-0适配/" style="font-size: 15px;">Android8.0适配</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/11/30/Kotlin/用Kotlin痛快的写脚本/">用Kotlin痛快的写脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/24/Android/工信部隐私问题快速排查整改方案/">工信部隐私问题快速排查整改方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/24/Android/Cronet网络协议选择之HTTP2与QUIC的竞速/">Cronet网络协议选择之HTTP2与QUIC的竞速</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/22/Android/Cronet实现HttpDns/">Cronet实现HttpDns</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/29/Android/Android获取应用磁盘空间占用/">Android获取应用磁盘空间占用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/Android/gradle之buildSrc代码调试/">gradle之buildSrc代码调试</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/19/Android/Android性能分析之systrace使用/">Android性能分析之systrace使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/03/Android/Tinker接入实践/">Tinker接入实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/21/Android/AOP技术在客户端的应用与实践/">AOP技术在客户端的应用与实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/13/Other/Git-Repo/">Git-Repo</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">Glan Wang.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>